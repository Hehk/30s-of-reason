{"dependencies":[{"name":"apollo-link","loc":{"line":9,"column":36}},{"name":"graphql/language/printer","loc":{"line":10,"column":22}},{"name":"apollo-link-dedup","loc":{"line":11,"column":42}},{"name":"apollo-utilities","loc":{"line":12,"column":173}},{"name":"../scheduler/scheduler","loc":{"line":13,"column":31}},{"name":"../errors/ApolloError","loc":{"line":14,"column":43}},{"name":"../util/Observable","loc":{"line":15,"column":27}},{"name":"../data/mutations","loc":{"line":16,"column":30}},{"name":"../data/queries","loc":{"line":17,"column":27}},{"name":"./ObservableQuery","loc":{"line":18,"column":32}},{"name":"./networkStatus","loc":{"line":19,"column":56}},{"name":"./types","loc":{"line":20,"column":26}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.QueryManager=void 0;var e=require(\"apollo-link\"),t=require(\"graphql/language/printer\"),r=require(\"apollo-link-dedup\"),o=require(\"apollo-utilities\"),i=require(\"../scheduler/scheduler\"),n=require(\"../errors/ApolloError\"),a=require(\"../util/Observable\"),u=require(\"../data/mutations\"),s=require(\"../data/queries\"),c=require(\"./ObservableQuery\"),l=require(\"./networkStatus\"),h=require(\"./types\"),y=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},d={listeners:[],invalidated:!1,document:null,newData:null,lastRequestId:null,observableQuery:null,subscriptions:[]},f=function(){function f(t){var o=t.link,n=t.queryDeduplication,a=void 0!==n&&n,c=t.store,l=t.onBroadcast,h=void 0===l?function(){}:l,y=t.ssrMode,d=void 0!==y&&y;this.mutationStore=new u.MutationStore,this.queryStore=new s.QueryStore,this.idCounter=1,this.queries=new Map,this.fetchQueryPromises=new Map,this.queryIdsByName={},this.link=o,this.deduplicator=e.ApolloLink.from([new r.DedupLink,o]),this.queryDeduplication=a,this.dataStore=c,this.onBroadcast=h,this.scheduler=new i.QueryScheduler({queryManager:this,ssrMode:d})}return f.prototype.mutate=function(r){var i=this,a=r.mutation,u=r.variables,s=r.optimisticResponse,c=r.updateQueries,l=r.refetchQueries,h=void 0===l?[]:l,d=r.update,f=r.errorPolicy,p=void 0===f?\"none\":f,v=r.fetchPolicy,m=r.context,Q=void 0===m?{}:m;if(!a)throw new Error(\"mutation option is required. You must specify your GraphQL document in the mutation option.\");if(v&&\"no-cache\"!==v)throw new Error(\"fetchPolicy for mutations currently only supports the 'no-cache' policy\");var b=this.generateQueryId(),g=this.dataStore.getCache();a=g.transformDocument(a),u=(0,o.assign)({},(0,o.getDefaultValues)((0,o.getMutationDefinition)(a)),u);var w=(0,t.print)(a);this.setQuery(b,function(){return{document:a}});var q=function(){var e={};return c&&Object.keys(c).forEach(function(t){return(i.queryIdsByName[t]||[]).forEach(function(r){e[r]={updater:c[t],query:i.queryStore.get(r)}})}),e};return this.mutationStore.initMutation(b,w,u),this.dataStore.markMutationInit({mutationId:b,document:a,variables:u||{},updateQueries:q(),update:d,optimisticResponse:s}),this.broadcastQueries(),new Promise(function(t,r){var o,c,l=i.buildOperationForLink(a,u,y({},Q,{optimisticResponse:s}));(0,e.execute)(i.link,l).subscribe({next:function(e){e.errors&&\"none\"===p?c=new n.ApolloError({graphQLErrors:e.errors}):(i.mutationStore.markMutationResult(b),\"no-cache\"!==v&&i.dataStore.markMutationResult({mutationId:b,result:e,document:a,variables:u||{},updateQueries:q(),update:d}),o=e)},error:function(e){i.mutationStore.markMutationError(b,e),i.dataStore.markMutationComplete({mutationId:b,optimisticResponse:s}),i.broadcastQueries(),i.setQuery(b,function(){return{document:void 0}}),r(new n.ApolloError({networkError:e}))},complete:function(){c&&i.mutationStore.markMutationError(b,c),i.dataStore.markMutationComplete({mutationId:b,optimisticResponse:s}),i.broadcastQueries(),c?r(c):(\"function\"==typeof h&&(h=h(o)),h.forEach(function(e){\"string\"!=typeof e?i.query({query:e.query,variables:e.variables,fetchPolicy:\"network-only\"}):i.refetchQueryByName(e)}),i.setQuery(b,function(){return{document:void 0}}),\"ignore\"===p&&o&&o.errors&&delete o.errors,t(o))}})})},f.prototype.fetchQuery=function(e,r,i,a){var u,s=this,c=r.variables,l=void 0===c?{}:c,y=r.metadata,d=void 0===y?null:y,f=r.fetchPolicy,p=void 0===f?\"cache-first\":f,v=this.dataStore.getCache().transformDocument(r.query),m=\"network-only\"===p||\"no-cache\"===p;if(i!==h.FetchType.refetch&&\"network-only\"!==p&&\"no-cache\"!==p){var Q=this.dataStore.getCache().diff({query:v,variables:l,returnPartialData:!0,optimistic:!1});m=!Q.complete||\"cache-and-network\"===p,u=Q.result}var b=m&&\"cache-only\"!==p&&\"standby\"!==p;(0,o.hasDirectives)([\"live\"],v)&&(b=!0);var g=this.generateRequestId(),w=this.updateQueryWatch(e,v,r);if(this.setQuery(e,function(){return{document:v,lastRequestId:g,invalidated:!0,cancel:w}}),this.invalidate(!0,a),this.queryStore.initQuery({queryId:e,queryString:(0,t.print)(v),document:v,storePreviousVariables:b,variables:l,isPoll:i===h.FetchType.poll,isRefetch:i===h.FetchType.refetch,metadata:d,fetchMoreForQueryId:a}),this.broadcastQueries(),(!b||\"cache-and-network\"===p)&&(this.queryStore.markQueryResultClient(e,!b),this.invalidate(!0,e,a),this.broadcastQueries()),b){var q=this.fetchRequest({requestId:g,queryId:e,document:v,options:r,fetchMoreForQueryId:a}).catch(function(t){if((0,n.isApolloError)(t))throw t;var r=s.getQuery(e).lastRequestId;throw g>=(r||1)&&(s.queryStore.markQueryError(e,t,a),s.invalidate(!0,e,a),s.broadcastQueries()),s.removeFetchQueryPromise(g),new n.ApolloError({networkError:t})});if(\"cache-and-network\"!==p)return q;q.catch(function(){})}return Promise.resolve({data:u})},f.prototype.queryListenerForObserver=function(e,t,r){var i=this,a=!1;return function(u,s){if(i.invalidate(!1,e),u){var c=i.getQuery(e).observableQuery,h=c?c.options.fetchPolicy:t.fetchPolicy;if(\"standby\"!==h){var y=c?c.options.errorPolicy:t.errorPolicy,d=c?c.getLastResult():null,f=c?c.getLastError():null,p=!s&&null!=u.previousVariables||\"cache-only\"===h||\"cache-and-network\"===h,v=Boolean(d&&u.networkStatus!==d.networkStatus),m=y&&(f&&f.graphQLErrors)!==u.graphQLErrors&&\"none\"!==y;if(!(0,l.isNetworkRequestInFlight)(u.networkStatus)||v&&t.notifyOnNetworkStatusChange||p){if((!y||\"none\"===y)&&u.graphQLErrors&&u.graphQLErrors.length>0||u.networkError){var Q=new n.ApolloError({graphQLErrors:u.graphQLErrors,networkError:u.networkError});if(a=!0,r.error)try{r.error(Q)}catch(e){setTimeout(function(){throw e},0)}else setTimeout(function(){throw Q},0),(0,o.isProduction)()||console.info(\"An unhandled error was thrown because no error handler is registered for the query \"+u.queryString);return}try{var b=void 0,g=void 0;if(s)i.setQuery(e,function(){return{newData:null}}),b=s.result,g=!s.complete&&!s.complete;else if(d&&d.data&&!m)b=d.data,g=!1;else{var w=i.getQuery(e).document,q=i.dataStore.getCache().diff({query:w,variables:u.previousVariables||u.variables,optimistic:!0});b=q.result,g=!q.complete}var S=void 0;if(S=g&&\"cache-only\"!==h?{data:d&&d.data,loading:(0,l.isNetworkRequestInFlight)(u.networkStatus),networkStatus:u.networkStatus,stale:!0}:{data:b,loading:(0,l.isNetworkRequestInFlight)(u.networkStatus),networkStatus:u.networkStatus,stale:!1},\"all\"===y&&u.graphQLErrors&&u.graphQLErrors.length>0&&(S.errors=u.graphQLErrors),r.next)if(!(d&&S&&d.networkStatus===S.networkStatus&&d.stale===S.stale&&d.data===S.data)||a)try{r.next((0,o.maybeDeepFreeze)(S))}catch(e){setTimeout(function(){throw e},0)}a=!1}catch(e){return a=!0,void(r.error&&r.error(new n.ApolloError({networkError:e})))}}}}}},f.prototype.watchQuery=function(e,t){if(void 0===t&&(t=!0),\"standby\"===e.fetchPolicy)throw new Error('client.watchQuery cannot be called with fetchPolicy set to \"standby\"');var r=(0,o.getQueryDefinition)(e.query);if(r.variableDefinitions&&r.variableDefinitions.length){var i=(0,o.getDefaultValues)(r);e.variables=(0,o.assign)({},i,e.variables)}void 0===e.notifyOnNetworkStatusChange&&(e.notifyOnNetworkStatusChange=!1);var n=y({},e);return new c.ObservableQuery({scheduler:this.scheduler,options:n,shouldSubscribe:t})},f.prototype.query=function(e){var t=this;if(!e.query)throw new Error(\"query option is required. You must specify your GraphQL document in the query option.\");if(\"Document\"!==e.query.kind)throw new Error('You must wrap the query string in a \"gql\" tag.');if(e.returnPartialData)throw new Error(\"returnPartialData option only supported on watchQuery.\");if(e.pollInterval)throw new Error(\"pollInterval option only supported on watchQuery.\");if(void 0!==e.notifyOnNetworkStatusChange)throw new Error('Cannot call \"query\" with \"notifyOnNetworkStatusChange\" option. Only \"watchQuery\" has that option.');e.notifyOnNetworkStatusChange=!1;var r=this.idCounter,o=new Promise(function(i,n){return t.addFetchQueryPromise(r,o,i,n),t.watchQuery(e,!1).result().then(function(e){t.removeFetchQueryPromise(r),i(e)}).catch(function(e){t.removeFetchQueryPromise(r),n(e)})});return o},f.prototype.generateQueryId=function(){var e=this.idCounter.toString();return this.idCounter++,e},f.prototype.stopQueryInStore=function(e){this.queryStore.stopQuery(e),this.invalidate(!0,e),this.broadcastQueries()},f.prototype.addQueryListener=function(e,t){this.setQuery(e,function(e){var r=e.listeners;return{listeners:(void 0===r?[]:r).concat([t]),invalidate:!1}})},f.prototype.updateQueryWatch=function(e,t,r){var o=this,i=this.getQuery(e).cancel;i&&i();return this.dataStore.getCache().watch({query:t,variables:r.variables,optimistic:!0,previousResult:function(){var t=null,r=o.getQuery(e).observableQuery;if(r){var i=r.getLastResult();i&&(t=i.data)}return t},callback:function(t){o.setQuery(e,function(){return{invalidated:!0,newData:t}})}})},f.prototype.addFetchQueryPromise=function(e,t,r,o){this.fetchQueryPromises.set(e.toString(),{promise:t,resolve:r,reject:o})},f.prototype.removeFetchQueryPromise=function(e){this.fetchQueryPromises.delete(e.toString())},f.prototype.addObservableQuery=function(e,t){this.setQuery(e,function(){return{observableQuery:t}});var r=(0,o.getQueryDefinition)(t.options.query);if(r.name&&r.name.value){var i=r.name.value;this.queryIdsByName[i]=this.queryIdsByName[i]||[],this.queryIdsByName[i].push(t.queryId)}},f.prototype.removeObservableQuery=function(e){var t=this.getQuery(e),r=t.observableQuery,i=t.cancel;if(i&&i(),r){var n=(0,o.getQueryDefinition)(r.options.query),a=n.name?n.name.value:null;this.setQuery(e,function(){return{observableQuery:null}}),a&&(this.queryIdsByName[a]=this.queryIdsByName[a].filter(function(e){return!(r.queryId===e)}))}},f.prototype.resetStore=function(){this.fetchQueryPromises.forEach(function(e){(0,e.reject)(new Error(\"Store reset while query was in flight.\"))});var e=[];this.queries.forEach(function(t,r){t.observableQuery&&e.push(r)}),this.queryStore.reset(e),this.mutationStore.reset();var t=this.dataStore.reset(),r=this.getObservableQueryPromises();return this.broadcastQueries(),t.then(function(){return Promise.all(r)})},f.prototype.getObservableQueryPromises=function(e){var t=this,r=[];return this.queries.forEach(function(o,i){var n=o.observableQuery;if(n){var a=n.options.fetchPolicy;n.resetLastResults(),\"cache-only\"===a||!e&&\"standby\"===a||r.push(n.refetch()),t.setQuery(i,function(){return{newData:null}}),t.invalidate(!0,i)}}),r},f.prototype.reFetchObservableQueries=function(e){var t=this.getObservableQueryPromises(e);return this.broadcastQueries(),Promise.all(t)},f.prototype.startQuery=function(e,t,r){return this.addQueryListener(e,r),this.fetchQuery(e,t).catch(function(){}),e},f.prototype.startGraphQLSubscription=function(t){var r,i=this,n=t.query,u=this.dataStore.getCache().transformDocument(n),s=(0,o.assign)({},(0,o.getDefaultValues)((0,o.getOperationDefinition)(n)),t.variables),c=[];return new a.Observable(function(t){if(c.push(t),1===c.length){var o={next:function(e){i.dataStore.markSubscriptionResult(e,u,s),i.broadcastQueries(),c.forEach(function(t){t.next&&t.next(e)})},error:function(e){c.forEach(function(t){t.error&&t.error(e)})}},n=i.buildOperationForLink(u,s);r=(0,e.execute)(i.link,n).subscribe(o)}return function(){0===(c=c.filter(function(e){return e!==t})).length&&r&&r.unsubscribe()}})},f.prototype.stopQuery=function(e){this.removeQuery(e),this.stopQueryInStore(e)},f.prototype.removeQuery=function(e){this.getQuery(e).subscriptions.forEach(function(e){return e.unsubscribe()}),this.queries.delete(e)},f.prototype.getCurrentQueryResult=function(e){var t=e.options,r=t.variables,i=t.query,n=e.getLastResult(),a=this.getQuery(e.queryId).newData;if(a)return(0,o.maybeDeepFreeze)({data:a.result,partial:!1});try{var u=this.dataStore.getCache().read({query:i,variables:r,previousResult:n?n.data:void 0,optimistic:!0});return(0,o.maybeDeepFreeze)({data:u,partial:!1})}catch(e){return(0,o.maybeDeepFreeze)({data:{},partial:!0})}},f.prototype.getQueryWithPreviousResult=function(e){var t;if(\"string\"==typeof e){var r=this.getQuery(e).observableQuery;if(!r)throw new Error(\"ObservableQuery with this id doesn't exist: \"+e);t=r}else t=e;var o=t.options,i=o.variables,n=o.query;return{previousResult:this.getCurrentQueryResult(t).data,variables:i,document:n}},f.prototype.broadcastQueries=function(){var e=this;this.onBroadcast(),this.queries.forEach(function(t,r){t.invalidated&&t.listeners&&t.listeners.filter(function(e){return!!e}).forEach(function(o){o(e.queryStore.get(r),t.newData)})})},f.prototype.fetchRequest=function(t){var r,o,i=this,a=t.requestId,u=t.queryId,s=t.document,c=t.options,h=t.fetchMoreForQueryId,d=c.variables,f=c.context,p=c.errorPolicy,v=void 0===p?\"none\":p,m=c.fetchPolicy,Q=this.buildOperationForLink(s,d,y({},f,{forceFetch:!this.queryDeduplication})),b=new Promise(function(t,c){i.addFetchQueryPromise(a,b,t,c);var y=(0,e.execute)(i.deduplicator,Q).subscribe({next:function(e){var t=i.getQuery(u).lastRequestId;if(a>=(t||1)){if(\"no-cache\"!==m)try{i.dataStore.markQueryResult(e,s,d,h,\"ignore\"===v)}catch(e){return void c(e)}i.queryStore.markQueryResult(u,e,h),i.invalidate(!0,u,h),i.broadcastQueries()}if(e.errors&&\"none\"===v)c(new n.ApolloError({graphQLErrors:e.errors}));else if(\"all\"===v&&(o=e.errors),h)r=e.data;else try{r=i.dataStore.getCache().read({variables:d,query:s,optimistic:!1})}catch(e){}},error:function(e){i.removeFetchQueryPromise(a),i.setQuery(u,function(e){return{subscriptions:e.subscriptions.filter(function(e){return e!==y})}}),c(e)},complete:function(){i.removeFetchQueryPromise(a),i.setQuery(u,function(e){return{subscriptions:e.subscriptions.filter(function(e){return e!==y})}}),t({data:r,errors:o,loading:!1,networkStatus:l.NetworkStatus.ready,stale:!1})}});i.setQuery(u,function(e){return{subscriptions:e.subscriptions.concat([y])}})});return b},f.prototype.refetchQueryByName=function(e){var t=this,r=this.queryIdsByName[e];if(void 0!==r)return Promise.all(r.map(function(e){return t.getQuery(e).observableQuery}).filter(function(e){return!!e}).map(function(e){return e.refetch()}))},f.prototype.generateRequestId=function(){var e=this.idCounter;return this.idCounter++,e},f.prototype.getQuery=function(e){return this.queries.get(e)||y({},d)},f.prototype.setQuery=function(e,t){var r=this.getQuery(e),o=y({},r,t(r));this.queries.set(e,o)},f.prototype.invalidate=function(e,t,r){t&&this.setQuery(t,function(){return{invalidated:e}}),r&&this.setQuery(r,function(){return{invalidated:e}})},f.prototype.buildOperationForLink=function(e,t,r){var i=this.dataStore.getCache();return{query:i.transformForLink?i.transformForLink(e):e,variables:t,operationName:(0,o.getOperationName)(e)||void 0,context:y({},r,{cache:i})}},f}();exports.QueryManager=f;"},"hash":"b81bdbcb66afbc88ebc2eba2fe7b1378","cacheData":{"env":{}}}